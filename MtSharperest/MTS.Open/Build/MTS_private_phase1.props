<?xml version="1.0" encoding="utf-8"?>

<!-- 
M_ProjectType comes in here as one of: 
Bruted: a project generated by brute
Native: a native (i.e. c++) library (actually a static library)
Managed: a managed library (actually a dll assembly)
Game: a managed game (a .net exe)
-->


<Project ToolsVersion="4.0" DefaultTargets="MTSIntegrityChecks" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!--==========================================================================-->
	<!-- PHASE 1 -->
	<!-- The stuff in this file needs to happen BEFORE Microsoft.Cpp.Default.props and Microsoft.Cpp.props are imported -->
	<!--==========================================================================-->

	<!-- FIX MSBUILD -->
	<PropertyGroup Label="Globals">
		<!-- warning MSB8027: Two or more files with the name of X.cpp will produce outputs to the same location. This can lead to an incorrect build result. -->
		<IgnoreWarnCompileDuplicatedFilename>true</IgnoreWarnCompileDuplicatedFilename>

		<!-- Well, I'm not supporting vs2010 anymore, but it was a good VS version. this will make sure we can detect it and function OK if we need to -->
		<!-- http://sedodream.com/PermaLink,guid,a5894bad-f2a1-441a-a5b2-74f16c6cf8aa.aspx -->
		<VisualStudioVersion Condition="'$(VisualStudioVersion)' == ''">10.0</VisualStudioVersion>

		<!-- Toolset must be changed early on......... I dont know why............ (edit: must it?)-->
		<!-- Let's just choose whatever toolset would be included with the VS version we're running -->
		<PlatformToolset Condition="'$(VisualStudioVersion)' == '14.0'">v140</PlatformToolset>
		<PlatformToolset Condition="'$(VisualStudioVersion)' == '15.0'">v141</PlatformToolset>

	</PropertyGroup>
	
	<!-- MSVC gets angry if this isn't set (for me, editing vcxproj properties in IDE breaks; others may have other problems) -->
	<!-- see https://developercommunity.visualstudio.com/content/problem/140294/windowstargetplatformversion-makes-it-impossible-t.html -->
	<!-- Setting these has the annoying side effect of making msvc edit the value in the vcxproj whenever we edit anything else. nothing seems to be capable of preventing that -->
	<PropertyGroup Condition="'$(WindowsTargetPlatformVersion)'==''" Label="Globals">
		<!-- <WindowsTargetPlatformVersion>8.1</WindowsTargetPlatformVersion> -->
			<LatestTargetPlatformVersion>$([Microsoft.Build.Utilities.ToolLocationHelper]::GetLatestSDKTargetPlatformVersion('Windows', '10.0'))</LatestTargetPlatformVersion>
			<WindowsTargetPlatformVersion Condition="'$(WindowsTargetPlatformVersion)' == ''">$(LatestTargetPlatformVersion)</WindowsTargetPlatformVersion>
			<TargetPlatformVersion>$(WindowsTargetPlatformVersion)</TargetPlatformVersion>
	</PropertyGroup>

	<!-- Calculate root directory for all operations -->
	<PropertyGroup Label="Globals">
		<M_PackagesDir>$(MSBuildThisFileDirectory)../../../../</M_PackagesDir>
	</PropertyGroup>
	
	<!-- Find out which platforms are available. Well, this is an example of that. I don't think it's needed. -->
	<PropertyGroup Label="Globals">
		<M_Has_Switch Condition="Exists('$(M_PackagesDir)/Motherload.Switch')">true</M_Has_Switch>
		<M_Has_PS4 Condition="Exists('$(M_PackagesDir)/Motherload.PS4')">true</M_Has_PS4>
	</PropertyGroup>
	

	<PropertyGroup Label="Globals">
		<M_VcxprojPropsPath>$(MSBuildProjectDirectory)\$(MSBuildProjectName).props</M_VcxprojPropsPath>
		<M_BrutedPropsPath>$(SolutionDir)\$(SolutionName).props</M_BrutedPropsPath>
	</PropertyGroup>
	
	<!-- bruted projects include only M_BrutedPropsPath; native projects include M_VcxprojPropsPath as well-->
	<!-- This needs to be done EARLY... so we can find out what platform we are from the M_BrutedPropsPath -->
	<!-- If the vcxproj props files need to do anything sneaky to msbuild internals, we will need to manage that process ourselves or add yet another props file (phase1 and phase2 distinction -->
	<Import Condition="Exists('$(M_BrutedPropsPath)')" Project="$(M_BrutedPropsPath)" />
	<Import Condition="Exists('$(M_VcxprojPropsPath)') AND '$(M_ProjectType)'=='Native'" Project="$(M_VcxprojPropsPath)" />
	
	<!-- Figure out what hardware platform we are. This could be some combination of logic I'm not sure about yet, but it's simply the brute platform for now -->
	<PropertyGroup Label="Globals">
		<M_BRUTE_PlatformName Condition="'$(M_BRUTE_PlatformName)' == ''">Proto</M_BRUTE_PlatformName>
		
		<M_PlatformType>$(M_BRUTE_PlatformName)</M_PlatformType>
	</PropertyGroup>

	<!-- Pick project configuration type -->
	<PropertyGroup Label="Globals">
		<!-- WARNING: THIS BLOB OF STUFF HAS TO BE DONE TWICE -->
		<ConfigurationType Condition="'$(M_ProjectType)'=='Bruted'">Application</ConfigurationType>
		<ConfigurationType Condition="'$(M_ProjectType)'=='Native'">StaticLibrary</ConfigurationType>
		<ConfigurationType Condition="'$(M_ProjectType)'=='Native' AND '$(M_BRUTE_PlatformName)'=='Proto'">DynamicLibrary</ConfigurationType>		
	</PropertyGroup>
	
	<PropertyGroup Label="Globals">
		<!-- BRUTE is thoroughly emulating .net which uses unicode, so... -->
		<CharacterSet>Unicode</CharacterSet>
	</PropertyGroup>	
	
	<!-- Setup staging directories, OutDir and IntDir, etc. -->
	<PropertyGroup>
	
		<!-- set build directories and staging dirs -->
		<!-- build directory can go under the brute output -->
		<IntDir>$(SolutionDir).obj\$(MSBuildProjectName) ($(Configuration)-$(Platform))\</IntDir>
		<M_StagingDir>$(SolutionDir)..\</M_StagingDir>
	
		<!-- applications go to a useful location. since the sku and thus M_StagingDir is implied by SolutionPlatform, go into  subdir based on SolutionConfiguration -->
		<OutDir Condition="'$(M_ProjectType)'=='Bruted'">$(M_StagingDir).bin\$(SolutionPlatform)\</OutDir>
		<!-- native libraries just go to the IntDir -->
		<!-- however, we want proto native libraries (as theyre DLLs vs+msbuild cant reference+copy well) to go to the output directory -->
		<OutDir Condition="'$(M_ProjectType)'=='Native'">$(IntDir)</OutDir>
		<OutDir Condition="'$(M_ProjectType)'=='Native' AND '$(M_BRUTE_PlatformName)'=='Proto'">$(SolutionDir).bin\$(SolutionPlatform)\</OutDir>
		
		<!-- for c# -->
		<OutputPath>$(SolutionDir).bin\$(SolutionPlatform)\</OutputPath>
		<BaseIntermediateOutputPath>$(IntDir)</BaseIntermediateOutputPath>
		
	</PropertyGroup>
	
	<!--==========================================================================-->
	<!-- PROPERTIES (standard build environment) -->
	<PropertyGroup>

		<!-- Note: this may need to vary by platform -->
		<TargetPath>$(OutDir)$(TargetName)$(TargetExt)</TargetPath>
		
	</PropertyGroup>
	
	<!--============================-->
	<!-- standard stuff for c# (some of this has to go in phase1...) -->
	<!-- AT LEAST DefineConstants has to go first. Don't know about anything else, but this all seems OK here -->
	<PropertyGroup>
		<AllowUnsafeBlocks>true</AllowUnsafeBlocks>
		<CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
		<ErrorReport>prompt</ErrorReport>
		<PlatformTarget>x64</PlatformTarget>
		<DebugType>pdbonly</DebugType>
		<UseVSHostingProcess>false</UseVSHostingProcess> <!-- this just gets on my nerves while testing the build system when i delete old junk dirs. maybe it's nice, I dont know. -->
	</PropertyGroup>
	
	<PropertyGroup Condition="'$(M_ProjectType)' == 'Managed'">
	</PropertyGroup>
	
	<PropertyGroup Condition="'$(Configuration)' == 'Debug'">
		<MyDefineConstants>DEBUG;TRACE;$(MyDefineConstants)</MyDefineConstants>
		<DebugSymbols>true</DebugSymbols>
		<DebugType>full</DebugType>		
	</PropertyGroup>
	
	<PropertyGroup Condition="'$(Configuration)' == 'Release'">
		<MyDefineConstants>$(MyDefineConstants)</MyDefineConstants>
		<Optimize>true</Optimize>
	</PropertyGroup>
	
	<PropertyGroup Condition="'$(Configuration)' == 'Brute'">
		<MyDefineConstants>BRUTED;$(MyDefineConstants)</MyDefineConstants>
	</PropertyGroup>	
	
	<PropertyGroup Condition="'$(SolutionPlatform)' == 'Proto'">
		<MyDefineConstants>PROTO;$(MyDefineConstants)</MyDefineConstants>
	</PropertyGroup>		
	
	<PropertyGroup>
		<DefineConstants>$(MyDefineConstants)</DefineConstants>
	</PropertyGroup>	
	<!--============================-->

</Project>